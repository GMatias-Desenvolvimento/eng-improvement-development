<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Melhorias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="melhoria.css">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, private">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>



<section>
<div class="box">
<header><h1>Melhorias</h1></header>
    <form id="meuForm" enctype="multipart/form-data">
        <fieldset >
            <legend>Dados Gerais:</legend>
            <p>Nome da empresa:<input type="text" name="nomeEmpresa" required ></p>
            <p>Número de série da máquina:<input type="text" name="numeroSerie" required ></p>
            <p>Qual modelo da máquina:
                <select class="cursor" name="modelo">
                    <option value="Poliroll Hortifruti Pista Dupla">Poliroll Hortifruti Pista Dupla</option>
                    <option value="Poliroll Saco de Lixo Pista Dupla">Poliroll Saco de Lixo Pista Dupla</option>
                    <option value="Poliroll Saco de Lixo Simples">Poliroll Saco de Lixo Simples</option>
                    <option value="Poliroll Hortifruti Simples">Poliroll Hortifruti Simples</option>
                    <option value="Poliroll 900">Poliroll 900</option>
                    <option value="Multisac 850">Multisac 850</option>
                    <option value="Multisac 1100">Multisac 1100</option>
                    <option value="Multisac 1300">Multisac 1300</option>
                    <option value="Multisac 1400 - Plástico Bolha">Multisac 1400 - Plástico Bolha</option>
                    <option value="Multisac 1100 SF">Multisac 1100 SF</option>
                    <option value="Multisac 1300 SF">Multisac 1300 SF</option>
                    <option value="Multisac 1700 SF">Multisac 1700 SF</option>
                    <option value="Multisac 2000 SF">Multisac 2000 SF</option>
                    <option value="Polisac 1100 CS">Polisac 1100 CS</option>
                    <option value="Polipouch 500">Polipouch 500</option>
					<option value="Poliflexo">Poliflexo</option>
                </select>
            </p>
            <p>Qual controlador:
                <select class="cursor" name="controlador">
                    <option value="WEG">WEG</option>
                    <option value="Sirius">Sirius</option>
                </select>
            </p>
        </fieldset><br>
		
        <fieldset>
            <legend>Dados do Solicitante:</legend>
            <p>Nome do solicitante:<input type="text" name="nomeSolicitante" required ></p>
            <p>Departamento de trabalho:<input type="text" name="departamento" required ></p>
            <p>Data da solicitação:<input type="date" name="dataSolicitacao" required></p>
            <p><label for="descricaoMelhoria">Descrição da melhoria:</label></p>
            <textarea id="descricaoMelhoria" name="descricaoMelhoria" placeholder="Descreva com detalhes a melhoria" required rows="10"></textarea><br>
            <p>Anexar arquivo de apoio:<br>
                <input class="cursor" type="file" id="arquivo" name="arquivo" multiple>
            </p>
        </fieldset>

        <p><button type="submit" class="button_enviar">Enviar</button></p>
    </form><br><br>
		
	</div>
	</section>
	
	 <!-- Botão de Sair (Logout) -->
	        <button class="logout-button" id="btn-logout">Sair</button>
	        
	        <p id="user-info">Carregando informações do usuário...</p>
    </div>


<script>
const form = document.getElementById('meuForm');

form.addEventListener('submit', async (e) => {
      e.preventDefault();

    const arquivoInput = document.getElementById('arquivo');
    // Usaremos um array para armazenar os dados de todos os arquivos
    const arquivos = []; 

    // Processar arquivos
    if (arquivoInput && arquivoInput.files && arquivoInput.files.length > 0) {
        
        // Iterar sobre todos os arquivos selecionados
        for (const file of arquivoInput.files) {
            try {
                // Converte o arquivo para Base64
                const arquivoBase64 = await file.arrayBuffer().then(buffer => {
                    let binary = '';
                    const bytes = new Uint8Array(buffer);
                    const len = bytes.byteLength;
                    for (let i = 0; i < len; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    return btoa(binary);
                });
                
                // Adiciona o nome e o conteúdo Base64 ao array
                arquivos.push({
                    nome: file.name,
                    base64: arquivoBase64
                });

            } catch (fileError) {
                alert('Erro ao processar o arquivo: ' + file.name + ' - ' + fileError.message);
                return; // Interrompe o envio se houver erro em algum arquivo
            }
        }
    }

    // Montar objeto de dados
    const data = {
        nomeEmpresa: form.nomeEmpresa.value,
        numeroSerie: form.numeroSerie.value,
        modelo: form.modelo.value,
        controlador: form.controlador.value,
        nomeSolicitante: form.nomeSolicitante.value,
        departamento: form.departamento.value,
        dataSolicitacao: form.dataSolicitacao.value,
        descricaoMelhoria: form.descricaoMelhoria.value,
        // Agora enviamos o array de arquivos
        arquivos: arquivos 
    };
    // ... (O restante do código de envio permanece o mesmo)


    try {
        // IMPORTANTE: 
        const response = await fetch('https://script.google.com/macros/s/AKfycbztEnGMRRTmPsfC2DTm9JUUw3Tku5oLyYVn6mfqw5BgF26zQvDr3VSQPOQ9_Nbp2kd2/exec', {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {'Content-Type': 'application/json'},
            mode: 'no-cors' // Importante para evitar problemas de CORS
        });

        // Nota: Com mode: 'no-cors', a resposta será opaca e não poderemos fazer response.json()
        // Por isso, vamos assumir sucesso se a requisição for enviada sem erro
        alert('Formulário enviado com sucesso!');
        form.reset();

    } catch (error) {
        alert('Ocorreu um erro ao enviar o formulário: ' + error.message);
        console.error('Erro detalhado:', error);
    }
});
</script>
 <script type="module">
        // 1. Importar as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        // 2. Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCzGowyDJYkr4D2Pe_psZ3rxM21y50wvSA",
            authDomain: "desenvolvimentoeng.firebaseapp.com",
            projectId: "desenvolvimentoeng",
            storageBucket: "desenvolvimentoeng.firebasestorage.app",
            messagingSenderId: "973102662144",
            appId: "1:973102662144:web:d8476586a438568e884ee5"
        };

        // 3. Inicializar o Firebase e o serviço de Autenticação
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        const LOGIN_PAGE = "login.html";
        const logoutButton = document.getElementById('btn-logout');
        const userInfo = document.getElementById('user-info');

        // 4. PROTEÇÃO DE ROTA: Verificar o estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário está logado. Permite acesso e exibe informações.
                console.log("Usuário logado:", user.email);
                userInfo.textContent = `Logado como: ${user.email}`;
            } else {
                // Usuário NÃO está logado. Redireciona para a página de login.
                console.log("Usuário não logado. Redirecionando...");
                window.location.href = LOGIN_PAGE;
            }
        });

        // 5. FUNCIONALIDADE DE LOGOUT
        async function handleLogout() {
            try {
                await signOut(auth);
                // Após o logout, o onAuthStateChanged acima detectará a mudança
                // e redirecionará automaticamente para a página de login.
                console.log("Logout realizado com sucesso.");
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                alert("Ocorreu um erro ao tentar sair. Tente novamente.");
            }
        }

        // 6. Adicionar o listener de evento ao botão de Sair
        logoutButton.addEventListener('click', handleLogout);

    </script>
</body>
</html>
